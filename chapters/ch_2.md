## 第二章 电路基础

### 2.1 电源、电线、用电器

#### 2.1.1 电路激活过程

在泰拉瑞亚中，电路由电源、电线、用电器组成，电源在满足条件时会产生一个脉冲（激活型数字信号），经电线传导到用电器，用电器响应该信号。

电源或用电器处于图格图层，而电线在单独的电线图层，与电源或用电器处于不同的图层，它们可以重叠。如果某电线与某电源或用电器重叠，我们说该电源或用电器在该电线下，该电线在该电源或用电器上。

接下来的讨论中，将会用激活来表示电路的活跃状态：**电源激活 $\rightarrow$ 电源上的电线激活 $\rightarrow$ 电线下的用电器激活**。电源的激活指电源通过其上电线发出信号，电线的激活指其传递其下电源发出的信号到用电器，用电器的激活指其上电线被激活。

#### 2.1.2 电源和用电器

电源指可以激活其上电线的图格，每个电源有特定的激活条件。逻辑门被称为逻辑电源，除了逻辑门以外的电源被称为物理电源。物理电源可以将非电信号转换为电信号，是逻辑电路的输入端口。只有物理电源可以新建逻辑结算，逻辑电源不能新建逻辑结算。

> 如火把、拉杆、压力板、逻辑感应器等。

用电器指可被其上电线激活的图格，每个用电器有特定的响应方式。逻辑门灯被称为逻辑用电器，除了逻辑门灯以外的用电器被称为物理用电器。物理用电器可以将电信号转换为非电信号，是逻辑电路的输出端口。

> 如火把、传送机、大炮、烟花等。

而只由电线、逻辑电源（逻辑门）、逻辑用电器（逻辑门灯）组成的电路被称为逻辑电路。电路是由 **输入端口、逻辑电路、输出端口** 组成的。

> 存在即是电源又是用电器的图格，如计时器。

> 物理电源和物理用电器的激活条件和响应方式可查阅附录。

##### 多图格电源和用电器

对于由多个图格组成的电源，并不会因为一根电线连接该电源的多个图格而增加电源激活时该电线的激活次数，电线只连接多图格电源的一个图格和多个图格是一样的。在物理电源激活时，其上的每根电线都只会被激活一次。

> 但不同颜色的电线或同颜色但中间没有连接的电线不是一根电线，在电源激活时，其上的每根电线都会被激活一次。

对于由多个图格组成的用电器，并不会因为一根电线连接该用电器的多个图格而增加该电线激活时该用电器的响应次数，电线只连接多图格用电器的一个图格和多个图格是一样的。在一根电线激活时，其下的物理用电器只会响应一次。

> 但不同颜色的电线或同颜色但中间没有连接的电线不是一根电线，在激活用电器时，用电器会分别响应每一根电线上的每一次信号。

有些用电器的响应效果会根据激活图格的位置不同而改变，但是对于一次激活仍然只会响应一次。先执行的响应取决于电线结算顺序。

> 比如炮台，发射炮弹后不会转向，转向后不会发射炮弹。

##### 有冷却时间的用电器

有些用电器的响应会受到冷却时间限制，在冷却时间结束前被激活不会响应。

> 比如炮台、机关、雕像等。

有冷却时间的用电器被激活并响应后，用电器所在的所有图格坐标与冷却时间（帧）会被加入到所有有冷却时间的电路物品共用的冷却机关列表（多图格用电器的每个格子都会被加入）。

每帧冷却机关列表内的所有图格的冷却时间会减一，在图格冷却时间为零后，即冷却时间结束，该坐标会从列表中移除。

> 有冷却时间的用电器的名字和冷却时间可以在附录查询。

当列表已满或用电器的所有图格都在冷却列表中时（多图格用电器需要所有图格都在列表里），用电器被激活后不会响应。

> 计时器也使用冷却时间列表记录下一次激活的时间，但开启和关闭并不受冷却时间影响。列表满后开启的计时器不会激活。

将正在冷却的用电器挖掉并不会从列表中移除该用电器的图格，但挖掉计时器会将计时器从列表中移除，计时器不会再激活。

> 对于冷却时间相同的项，冷却机关列表是后进先出的，计时器电路中会使用这个性质。

没有冷却时间的用电器可以在一帧内被激活任意次数。

> 如逻辑门灯、炮台转向、像素盒、晶莹宝石块、促动器等。

##### 状态表示

有些电源看起来有两个或多个状态，并且每次状态切换会激活其上电线，这种电源被称为状态表示电源，简称状态电源。状态电源在不满足条件到满足条件和满足条件到不满足条件两种情况时都会激活。

> 如加重压力板有抬起和按下两种状态，在按下到抬起和抬起到按下时都会激活；普通逻辑门有亮和灭两种状态，在灭切换到亮和亮切换到灭都会激活。

有些用电器看起来有两个或多个状态，其上电线激活时会在几个状态间切换，这种用电器被称为状态表示用电器，简称状态用电器。状态用电器是有记忆的，它会记住之前的状态，下一次状态变化会在当前状态的基础上变化。

> 如火把和普通逻辑灯会在激活时由亮切换到灭，或由灭切换到亮，具体是哪种取决于激活前的状态。

对于有两个状态的电源或用电器，我们可以人为设定一个状态为 0（一般指灭或初始态），另一个状态为 1（一般指亮或另一态）。在不激活时，状态电源和用电器会维持之前的状态不变。

> 也有一些状态电源和用电器不止两个状态，比如烟囱有三个状态、炮台有九个状态、彩线灯泡有十六个状态。

我们称只使用状态电源、状态用电器和电线的电路为状态表示电路，简称状态电路。状态表示电路的状态可以从电路中直接读出，所有电源和用电器的状态是同步变化的。

##### 激活表示

有些电源看起来只有一个状态，或者看起来有多个状态但是只在一个状态切换到另一个状态时会激活，反过来不会，这种电源被称为激活表示电源，简称激活电源。激活电源只在不满足条件到满足条件时激活，不会在满足条件到不满足条件时激活。

> 如普通压力板尽管看起来有抬起和按下两种状态，但是只会在抬起到按下时会激活，按下到抬起不会激活，所以是激活电源；而故障逻辑门看起来只有一种状态，是激活电源。

有些用电器看起来只有一个状态，这种用电器被称为激活表示用电器，简称激活用电器。激活用电器是没有记忆的，激活时会直接响应而不考虑之前的状态。

> 如广播盒会在被激活时发出内部文本，传送器会在被激活时传送上方人物与 NPC。

对于激活电源和用电器的每个周期，每个电源和用电器都有激活和不激活两种状态，我们可以令激活为 1，不激活为 0。在不激活时，激活电源和用电器会维持稳态（不激活）。

> 这里的周期指的是电路结算的最小单位，对于逻辑电路来说是逻辑帧。

我们称只使用激活电源、激活用电器和电线的电路为激活表示电路，简称激活电路。激活与否并不会改变激活电源和激活用电器的状态，所以电路的状态不能从电路中直接读出。

> 如果我们忽略状态电路的状态，那么也可以将状态电路看做激活电路。

##### 最简形式

上一节提到电路是由物理输入端口、逻辑电路、物理输出端口组成的，而逻辑电路是由逻辑电源（逻辑输入端口）、逻辑用电器（逻辑输出端口）、电线组成的。所以我们可以得到电路的最简形式：一根电线与其下所有的电源和用电器。这样的电路被称为最简形式电路，简称最简电路，任何电路都是由这样的一个或多个最简电路组成。

由于大部分电路同时包括状态表示和激活表示，所以对于电路状态表示和激活表示的讨论通常对最简电路进行。当最简电路中只有状态电源、状态用电器、电线时，被称为最简状态电路；当最简电路中只有激活电源、激活用电器、电线时，被称为最简激活电路。

当最简电路的电源中存在激活电源，用电器中存在状态用电器，则该最简电路存在激活转状态；当最简电路的电源中存在状态电源，用电器中存在激活用电器，则该最简电路存在状态转激活。

#### 2.1.3 电线

现实中的数字电路电线会有低电平、高电平、高阻态、未知态等状态，但是泰拉瑞亚中的电线只能传递脉冲信号（激活）一种信号，本身并没有状态或电平。电线只是标记电源和用电器的连接关系（拓扑关系），与颜色、长度和形状无关。电线没有长度和连接电源或用电器数量的限制，连接或不连接电线不会改变电源和用电器的状态。

> 电源和用电器有状态与激活两种，但是电线上传递的信号只有激活信号一种。

共有四种颜色的电线，相同颜色的电线在相邻图格会被连接到一起，而不同颜色的电线是在不同的图层上，不会被连接到一起。

使用分线盒或像素盒可以把一个图格内的相同颜色的电线分开。分线盒同时作用于一个图格中所有颜色的电线。一共有三种分线盒，分别把来自上下和左右、上左和下右、上右和下左的电线分开。像素盒只能将来自上下和左右的电线分开。

##### 参考状态

尽管电线是没有状态的，但是有时为了便于讨论，我们会假设电线有状态，这种状态被称为参考状态。最简状态电路中的电线被称为状态传递电线，简称状态电线；最简激活电路中的电线被称为激活传递电线，简称激活电线。当最简电路中同时存在激活和状态表示时，我们根据更加关注的是状态还是激活来选择电线的类型，通常由用电器的类型决定，忽略电源的类型。后文会用将状态电线的参考状态简称为电线的状态。

##### 线非

对于最简状态电路，电源和用电器的状态是同步变化的。但是由于电源和用电器的状态是可以人为设定的，如果我们设定一对电源和用电器的状态相反，将电源状态看做输入，将用电器看做输出，我们就会得到一个输入与输出始终相反的电路，也就是非逻辑。

像这样不使用逻辑门，只使用一个任意状态电源、一个任意状态用电器和一根电线实现的非逻辑被称为线非。由于线非的存在，我们可以在任意状态用电器出实现取反，而不需要使用逻辑门。

##### 线异或

两两异或逻辑又被叫做可控非逻辑，因为当一个输入为 0 时，输出与另一个输入相等；当一个输入为 1 时，输出为另一个输入的反相。考虑最简状态电路中的两个电源和一个用电器，将电源状态看做输入，将用电器看做输出，当一个输入为 0 时，输出与另一个输入相等；当一个输入为 1 时，输出为另一个输入的反相；满足两两异或逻辑。

由于两两异或具有交换率，交换两个输入对输出没有影响，所以输出与两个输入的顺序无关，具有普适性。同理，两两异或具有结合律，所以即便有多个输入，输出仍然满足所有输入间两两异或，可以任意扩展。

像这样不使用逻辑门，只使用多个状态电源和一个状态用电器实现两两异或逻辑的方式被称为线异或。由于线异或的存在，我们可以在任意状态用电器处实现两两异或，而不需要使用逻辑门。

> 注意区分线异或的两两异或和异或门的多输入异或逻辑在输入数量大于等于 3 时是不同的。

> 线非是线异或只有一个输入的特殊情况。

> 实际上状态用电器的最终状态是自身状态和其上所有电线上所有输入电源两两异或的结果，在用电器处完成，不要求所有输入电源都在同一根电线上。

> 线异或是最常用的运算。

##### 线或

或逻辑中，当任意输入为 1 时，输出为 1；只有全部输入都为 0 时，输出为 0。考虑最简激活电路中的多个电源和一个用电器，任意电源激活时，用电器会被激活；没有电源激活时，用电器不会被激活；满足或逻辑。

像这样不使用逻辑门，只使用多个激活电源和一个激活用电器实现或逻辑的方式被称为线或。由于线或的存在，我们可以在任意激活用电器处实现或，而不需要使用逻辑门。

> 多输入或与两两或等价，所以线或与多输入或门等价。

> 实际上激活用电器是否激活，取决于其上所有电线上所有输入电源中是否有激活的电源，在用电器处完成，不要求所有输入电源都在同一根电线上。

> 然而对于没有冷却时间的物理激活用电器（如广播盒），被激活一次就会响应一次，即便是同时激活多次，每一次都会单独响应，并不是严格的线或逻辑。

> 严格的线或逻辑只存在于逻辑电路，通常用于检测多位信号中是否存在或全为 0 / 1，用来代替较大的多输入或门，较线异或应用较少。

### 2.2 逻辑门

#### 2.2.1 逻辑门灯和逻辑门

泰拉瑞亚中的逻辑门由逻辑门和逻辑门灯组成，逻辑门灯可以被堆叠于逻辑门上，逻辑门的状态取决于其上中间不相隔任何非逻辑灯图格的全部逻辑门灯的状态。

##### 逻辑门灯

逻辑门灯有三种，分别是 **逻辑门灯（亮）、逻辑门灯（灭）、逻辑门灯（故障）** 。其中逻辑门灯（亮）和逻辑门灯（灭）被称为普通逻辑门灯，简称普通灯；逻辑门灯（故障）被称为故障逻辑门灯，简称故障灯。

逻辑灯是用电器，输入是电线，输出是逻辑门。普通灯是状态用电器，有记忆，输入满足线非和线异或逻辑；故障灯是激活用电器，无记忆，输入满足线或逻辑。

逻辑灯必须堆叠在逻辑门上，我们说这些逻辑灯在该逻辑门上，该逻辑门在这些逻辑灯下。

##### 逻辑门

当逻辑门上没有故障灯时，逻辑门被称为普通逻辑门，简称普通门；当逻辑门上有故障灯时，逻辑门变成蓝色，被称为故障逻辑门，简称故障门。

逻辑门是电源，输入是逻辑灯，输出是电线，普通门是状态电源，状态取决于其上普通灯状态；故障门是激活电源，激活取决于其上故障灯激活。一个逻辑灯只对应一个逻辑门，而一个逻辑门可以对应任意多个逻辑灯。

#### 2.2.2 普通逻辑门

普通门有 **与、与非、或、或非、异或、同或** 六种。普通门有亮和灭两种状态，由其上普通灯状态决定。如果普通灯是输入，普通门是输出，亮灯/门是 1，灭灯/门是 0，输入与输出的关系与上一章所述同名逻辑运算相同。

利用线非与反演律可以将六种普通门等价为与门和异或门两种普通门，与门在其上所有普通灯点亮时点亮，异或门在其上只有一个普通灯点亮时点亮。在任何电路中，都可以只使用这两种普通门实现全部逻辑，而不需要其它普通门。

普通灯是状态用电器，普通灯切换状态时，下方普通门会根据上方所有普通灯状态决定自己状态；而普通灯同时切换多次状态，下方普通门只会考虑普通灯的最后状态（即线异或），而不考虑中间状态。普通门是状态电源，在由亮到灭和由灭到亮切换状态时都会激活其上电线。

##### 逻辑门等价的证明

由于线非的存在，我们可以直接令输出状态用电器的状态与输入电源普通门的状态相反，令与门和与非门、或门和或非门、异或门和同或门等价。

类似乘法分配律这样的运算律，逻辑运算中也存在一些运算率，被称为逻辑运算律。反演律（摩根律）是一个常用的运算律，表述如下：

$$(A \cdot B)' = A' + B'$$

$$(A + B)' = A' \cdot B'$$

> 关于这个运算律的证明可以通过画图或者列真值表完成，对于三项及三项以上仍然是成立的。

将或门的逻辑表达式进行两次取反（两次取反结果不变），然后使用反演律可将或逻辑转换为与逻辑：

$$Y = A + B = (A + B)'' = (A' \cdot B')'$$

将与门的逻辑表达式进行两次取反（两次取反结果不变），然后使用反演律可将与逻辑转换为或逻辑：

$$Y = A \cdot B = (A \cdot B)'' = (A' + B')'$$

由此我们可以直接令输入状态电源的状态与输出用电器普通灯的状态相反，令与门和或非门、或门和与非门等价，然后再利用前述结论，可令与门和或门等价。

那么我们是否能将与门和异或门等价呢？不可能，原因会在后文介绍。在泰拉电路中，我们只使用与门和异或门就足够了，其他普通门都可以用这两种门代替。

#### 2.2.3 故障逻辑门

当在普通门上堆叠故障灯时，普通门会变成蓝色的故障门，所有故障门逻辑都是一样的，尽管它们看起来不同。

故障门与其上最靠下的故障灯之间的普通灯称为有效逻辑灯，简称有效灯。当故障逻辑门上有任意一个故障逻辑灯被激活时，故障门会按照有效灯中亮灯的数量比有效灯总数为概率激活。

> 由于故障门是概率激活的，所以又被叫做随机门。

故障门上的故障灯为激活用电器，而普通灯为状态用电器。改变普通灯的状态不会使故障门激活，而激活故障灯有可能会使故障门激活。一个故障逻辑门上的所有故障灯都是相同的，而除有效灯以外的普通灯的状态不会影响故障逻辑门的概率，除有效灯以外的普通灯可以看做不存在。故障灯每次激活时，故障门都有概率激活；而故障灯同时被激活多次，下方故障门每一次都会尝试判断激活（即线或）。故障门是激活电源，在成功激活时会激活其上电线。

### 2.3 逻辑结算

#### 2.3.1 逻辑结算

##### 帧结算

泰拉瑞亚中每一帧中，除电路外所有的游戏机制会依一定顺序结算，电路结算的位置和触发电路的物理电源结算位置有关。也就是说，当实体触发电路时，会在实体所在结算触发电路的位置插入一个电路结算，插入的电路结算被称为逻辑结算。

> 比如由某人物触发的压力板会在该人物结算的压力板结算位置处触发一个逻辑结算；由某射弹触发的垫板会在该射弹结算的垫板结算位置处触发一个逻辑结算。

##### 逻辑结算

当一个物理电源激活一次时，会新建一个逻辑结算，逻辑电源无法新建逻辑结算。

每帧内逻辑结算的数量没有限制，在逻辑结算结算完成前，后续的代码不会运行。无论逻辑结算的规模有多大，有多少逻辑门和多少电线，都会在一帧内完成。可以说泰拉瑞亚电路是没有频率上限且没有延迟的。

> 实际上频率会受限于能制作出来的驱动/时钟频率；延迟会受限于电脑性能，当计算量较大时，帧结算需要的时间会增加，物理帧会降低。

##### 逻辑帧结算

对于逻辑门电路，逻辑结算被分步进行，每一步中都进行 **电源（逻辑门）激活判断 $\rightarrow$ 电源（逻辑门）激活 $\rightarrow$ 电线激活 $\rightarrow$ 用电器（逻辑灯）激活** 四小步，我们将这样的四步统称为逻辑帧。一个逻辑电路的结算过程中，反复运行每个逻辑帧中的四小步，直到没有逻辑门需要激活。

在逻辑灯状态改变后，并不会马上进行逻辑灯下逻辑门是否激活的判断，而是在下一逻辑帧再进行激活判断。所以某一逻辑帧逻辑门是否激活只需要考虑逻辑门上逻辑灯在上一逻辑帧的终态，不需要考虑中间态（普通灯考虑亮灭，故障灯考虑被激活）。

逻辑帧是逻辑门电路的最小时间单位，逻辑帧内的事情是同时发生的，所以我们会以逻辑帧为单位分析逻辑门电路。两个相邻逻辑帧间相隔一个逻辑门，令物理电源所在逻辑帧为第 0 逻辑帧，每经过一个逻辑门逻辑帧 +1 ，可以通过数出一个信号从物理电源传递到某个逻辑门时经过的逻辑门数量，来计算该逻辑门在此逻辑结算所在逻辑帧位置。当需要分析一个信号到达两个逻辑门时相差多少逻辑帧时，我们可以上溯到它们最近的公共逻辑帧。

##### 电源结算

每个逻辑帧中，电线会先后激活一些逻辑灯，而这些逻辑灯下的逻辑门可能会在下一逻辑帧被激活。逻辑门激活的顺序取决于其上逻辑灯在上一逻辑帧被激活的顺序，先激活的逻辑灯下的逻辑门先激活，后激活的逻辑灯下的逻辑门后激活。

##### 电线结算

每个电源上的每个格子，会按照 **先从左到右，再从上到下** 激活每个格子里的电线。每个格子的四色电线中，会按照 **红 $\rightarrow$ 蓝 $\rightarrow$ 绿 $\rightarrow$ 黄** 的颜色顺序依次进行结算。

##### 格子结算

每根电线进行结算时，会从激活点开始，使用四连通广度优先搜索（BFS）来遍历该电线上连接的所有图格，添加到队列的顺序是 **下 $\rightarrow$ 上 $\rightarrow$ 右 $\rightarrow$ 左** 。

一般情况下，我们只需要知道，电线上各个格子按照沿电线上距离电源的距离由近到远的顺序激活。

#### 2.3.2 爆门

> 泰拉电路没有延迟，逻辑结算不完成程序不会继续执行，那么激活这样的电路会发生什么？

> 这会陷入死循环，卡死游戏吗？然而实际尝试后我们会发现逻辑门冒烟了，但是游戏并没有卡死，这是怎么回事呢？

泰拉为了防止无延迟的电路出现死循环卡死游戏，为逻辑门添加了一个设定：同一个逻辑门在一次逻辑结算中只能激活一次。如果尝试激活第二次，逻辑门的状态会正常切换，但是不会激活其上电线，并且会有白烟从逻辑门中冒出，这种现象被称为 **爆门**。

实际上，使用爆门来防止死循环，也会产生一些副作用，有些不会死循环的电路也会发生爆门。在实际应用中，爆门经常导致电路出问题，这是因为我们往往希望逻辑门在不同逻辑帧多次状态切换时可以多次激活，但实际上不会。学会了预测爆门，就可以想办法避免爆门，甚至利用爆门。

#### 2.3.3 竞争和冒险

输入信号通过两条或以上路径到达同一个逻辑门时，由于两条路径上的延迟（逻辑帧）不同，出现了到达先后时间差，被称为竞争；由于竞争的存在，先到达的信号激活逻辑门后，后到达的信号再想激活逻辑门会导致逻辑门爆门，出现错误，被称为冒险。

我们通常使用两个方法来避免爆门：

- 给先到达的信号添加逻辑延迟，让两个信号同时到达同一个逻辑门；

- 使用寄存器暂存信号，需要时再将它们同时发送给同一个逻辑门；
