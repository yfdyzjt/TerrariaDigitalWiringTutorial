## 第一章 电路基础

### 1.1 泰拉瑞亚基本概念

#### 1.1.1 实体

实体指的是可以发生碰撞的物体，包括但不限于[NPC](https://terraria.wiki.gg/zh/wiki/NPC)、[人物](https://terraria.wiki.gg/zh/wiki/%E4%BA%BA%E7%89%A9)、[射弹](https://terraria.wiki.gg/zh/wiki/%E5%B0%84%E5%BC%B9)、[物品](https://terraria.wiki.gg/zh/wiki/%E7%89%A9%E5%93%81)、[图格](https://terraria.wiki.gg/zh/wiki/%E5%9B%BE%E6%A0%BC_ID)。

史莱姆对玩家造成接触伤害，就是史莱姆（NPC）与玩家（人物）的碰撞；玩家用弓射出木箭击中了史莱姆，就是史莱姆（NPC）与木箭（射弹）的碰撞；玩家被血肉墙激光击中，就是玩家（人物）与激光（射弹）的碰撞；玩家、掉落物、大多数NPC、大多数射弹不能穿墙，是因为玩家、掉落物、NPC、射弹会和图格碰撞。

碰撞是通过碰撞箱判定的，例如史莱姆与玩家碰撞，是因为史莱姆的碰撞箱与玩家的碰撞箱有重叠。泰拉瑞亚中所有实体的碰撞箱均为矩形，有宽度和高度两个属性，大小可以在源码中查到。

#### 1.1.2 上限

泰拉瑞亚中许多实体都有数量上限，而数量上限又分为硬上限和软上限。硬上限是游戏中的静态常量，例如NPC硬上限200等。软上限是游戏中的变量，例如活跃刷怪数量（一般在5到15）等。从程序角度来说，硬上限是由定长数组的长度决定的，如果尝试突破会导致数组越界。为避免在正常游戏过程中出现崩溃现象，游戏程序中在关键函数中都有越界检查，例如NPC达到上限时，游戏会拒绝生成新NPC以防止崩溃。软上限是开发者对游戏的平衡控制，例如玩家附近的活跃敌怪数量到达15则不会进行刷怪。

以下是一些电路中可能用到的硬上限，其他上限可以在源码中获取：

| 对象 | 上限 |
| ---  | --- |
| 傀儡影子 | 100 |
| NPC | 200 |
| 玩家 | 255 |
| 射弹 | 1000 |
| 冷却机关 | 1000 |

#### 1.1.3 帧率

物理帧(tick) 指泰拉瑞亚中时间的最小单位，为 1/60 秒。在物理帧的尺度下，泰拉瑞亚是回合制游戏，每个物理帧中，除电路外所有的游戏机制会依一定顺序结算，电路结算的位置和触发电路的物理电源结算位置有关（关于物理电源的概念会在后续介绍）。本教程中未经特殊说明的情况下将直接用“帧”表示物理帧。

图像帧(frame) 指泰拉瑞亚游戏过程中电脑显示屏更新的每帧画面，在游戏中按F10可以在游戏窗口左下角显示当前图像帧率。建议将跳帧设置为隐蔽以使图像帧和物理帧相等，跳帧开会在物理帧降低时通过降低图像帧以使物理帧达到最大，跳帧关会令图像帧和屏幕刷新率相等，而不是物理帧。

#### 1.1.4 坐标

图格的坐标指的是图格在世界中的位置。坐标并非深度计与罗盘所显示的那样。程序中的坐标是以世界左上角为(0, 0)，横坐标向右增加，纵坐标向下增加。世界宽度为 maxTilesX 格，高度为 maxTilesY 格。世界右下角的坐标为 (maxTilesX - 1, maxTilesY - 1)。

以下是三种大小世界的 maxTilesX 和 maxTilesY，其中大世界的大小也是世界的最大大小：

| 世界 | maxTilesX | maxTilesY |
| ---  | --- | --- |
| 小世界 | 4200 | 1200 |
| 中世界 | 6400 | 1800 |
| 大世界 | 8400 | 2400 |

世界最外侧有一个区域在游戏中不可见的，且玩家不可到达，区域内的图格仍然存在，可以在地图编辑器里面看到它们，下表是每个方向不可见区域的宽度：

| 方向 | 宽度 |
| ---  | --- |
| 上 | 41 |
| 下 | 42 |
| 左 | 41 |
| 右 | 42 |

在不可见区域内的电路仍然可以正常运行，只有在世界最外侧2格宽的区域内的电路无法运行（各方向相同）。

#### 1.1.5 度量

泰拉瑞亚中的长度单位有：英里、格、英尺、像素。换算关系是 1 英里 = 5280 英尺 = 2640 格，1 格 = 2 英尺 = 16 像素。

> 尽管泰拉瑞亚的贴图是按照 8 × 8 像素绘制的，但是储存和计算时仍然是按照 16 × 16 像素。
>
> 在游戏中最大能看到 1920 × 1080 像素的范围，即便将游戏分辨率设置的更高，也会被缩放到这个范围内。

泰拉瑞亚中的时间单位有：帧、秒、分、天。换算关系是 1 天 = 24 分，1 分 = 60 秒，1 秒 = 60 帧。有的时候帧、秒、分也分别叫做游戏秒、游戏分、游戏时。

速度单位 = 长度单位/时间单位，主要有：英里/小时、格/秒、像素/帧。

程序内部的长度单位是像素，时间单位是帧，速度单位是像素/帧。

### 1.2 数字电路基本概念

#### 1.2.1 模拟电路与数字电路

在现实中存在着许多物理量，其中有一些物理量，比如温度、湿度、压力、速度等，它们在时间上和数值上都具有连续变化的特点，在一定范围内可以取任意实数值，通常称这种连续变化的物理量为模拟量，表示模拟量的电信号称为模拟信号。

还有一类物理量在时间和数值上都是离散的，它们的大小以及每次的增减变化都是某个最小单位的整数倍。比如每年的利润，若最小单位为元，显然它只能以元为单位增加或减少，并且以年为时间单位记录。这一类物理量称为数字量，表示数字量的电信号称为数字信号。

完成模拟信号产生、传输和处理的电路称为模拟电路；完成数字信号产生、传输和处理的电路称为数字电路。在数字电路中最常用的是只有0和1两种数值所组成的数字信号，这种二值数字信号又被称为二进制信号，这类信号中的数值0或1可以用电平的低或高来表示，也可以用脉冲的有或无来表示。

脉冲是一种特殊的信号形式，指在短持续时间内突变，随后又迅速返回其初始值的物理量变化过程。

```wavedrom
{ signal : [
  { name: "a", wave: "h..lhlhl"},
  { name: "b", wave: "p..lplpp"}
],
  head:{
   tick:0,
   every:1
  }
}
```

上图为两个数字信号 a 与 b 的波形图，展示了它们的幅值随时间的变化图像。

* 信号 a 是以高电平代表1，低电平代表0，称为电平型数字信号或不归0型数字信号；
* 信号 b 是以有脉冲代表1，无脉冲代表0，称为脉冲型数字信号或归0型数字信号；

每个1和0的持续时间为 $\Delta t$ ，称为信号周期（tick）。

> 信号周期（tick）和物理帧（tick）不同，泰拉瑞亚逻辑门电路是以逻辑帧，而不是物理帧为单位结算的。下文会用逻辑帧指代逻辑门电路结算的最小单位。

泰拉瑞亚的电路中并没有电压和电流这样的模拟量，电源、用电器和电线的状态在时间上和数值上都是离散的，所以泰拉电路只能产生、传输和处理数字量，泰拉电路是数字电路。

对于我们主要关注的逻辑门电路，其中只有0和1两种数值所组成的数字信号，所以逻辑门电路产生、传输和处理是二进制信号。

#### 1.2.2 二进制

按进位规则进行计数称为进位计数制，简称进制。在日常生活中我们最广泛使用的是十进制（Decimal），十进制有 0 ~ 9 十个数字。但在数字电路和计算机中，通常只有类似灯的亮灭、电线的通断、开关的闭合和抬起，这样的两种状态，所以只需要 0 和 1 两个数字来表示，使用的是二进制（Binary）。

十进制数可以被写做 $(345)_{10}$ ，读做“三百四十五”，这种使用 0 ~ 9 十个数字，每个数字在不同的数位上表示的大小不同的形式，被称为位置记数法。

> 下角标 10 表示括号里的数是十进制，下角标 2 表示括号里的数是二进制。

在十进制中，由于只有 0 ~ 9 十个数字，当表示大于 9 的数时，需要进行进位，也就是满 10 进 1 ， 9 + 1 = 10 。当 1 在十位上时，它是个位上的 1 的十倍。对于十进制数 $(345)_{10}$ ，3 在百位上，4 在十位上，5 在个位上；3 代表有三个 100，4 代表有四个 10，5 代表有五个 1。这里的 100、10、1 ，也就是 $10 ^ 2$、$10 ^ 1$、$10 ^ 0$ 是十进制数的位权，十进制数的各个数位的位权是 10 的位数次幂，幂数的底 10 被称为基数，几进制的基数就是几。十进制数第 $n$ 位数的位权是 $10 ^ {n-1}$。

同理，二进制中满足满 2 进 1 的进位规则，二进制数也可以按照位置记数法，被写做形如 $(10010)_{2}$ 的形式，表示有 1 个 16，0 个 8，0 个 4，1 个 2，0 个 1。每位的乘数 16、8、4、2、1，也就是 $2 ^ 4$、$2 ^ 3$、$2 ^ 2$、$2 ^ 1$、$2 ^ 0$ 是二进制数的位权，而二进制数的基数是2。二进制数第 $n$ 位数的位权是 $2 ^ {n-1}$。$R$ 进制数第 $n$ 位数的位权是 $R ^ {n-1}$

对于 3 位十进制数，可以表示 $(000)_{10}$ ~ $(999)_{10}$ ，共计 1000 （$10 ^ 3$）个数，也就是第四位的位权。同理对于五位二进制数，可以表示 $(00000)_{2}$ ~ $(11111)_{2}$ ，共计 32 （$2 ^ 5$）个数。由此可见，对于 $n$ 位二进制数，可以表示 $2 ^ n$ 个数；对于 $n$ 位 $R$ 进制数，可以表示 $R ^ n$ 个数。

#### 1.2.3 逻辑函数

数字电路的基本单元是开关器件，开关器件只有“接通”和“断开”两种状态，可以使用逻辑变量（二值变量）来描述，逻辑变量只有 0 和 1 两种可能的取值。函数是一种将一个集合中的每个元素（自变量）与另一个集合中的一个元素（因变量）关联起来的关系，逻辑函数是研究逻辑变量之间的因果关系的函数。对于有 $n$ 个逻辑变量 $(A_1, A_2, \cdots, A_n)$ 的逻辑函数，当 $n$ 个逻辑变量取任意一组确定值后，逻辑函数 $Y = F(A_1, A_2, \cdots, A_n)$ 的值也就被唯一地确定了，显然 $Y$ 也只有 0 或 1 两种可能的取值。

例如，存在一个两变量的逻辑函数 $Y = F(A, B)$ ，对于二位二进制，能表示 $2 ^ 2 = 4$ 个数，所以对于变量 $A$，$B$ 有 4 种可能的取值：00，01，10，11。我们可以令 $F(0, 0) = 0$， $F(0, 1) = 0$， $F(1, 0) = 0$， $F(1, 1) = 1$ 这样我们就得到了 $A$，$B$ 与 $Y$ 的完整映射关系。

#### 1.2.4 真值表

对于一个逻辑函数，我们可以使用真值表来描述它。真值表是一种列出一个逻辑函数的所有输入与其对应输出的表格。例如刚才的函数，我们可以使用下面的真值表来描述：

| 输入 A | 输入 B | 输出 Y |
| ---  | --- | --- |
| 0 | 0 | 0 |
| 0 | 1 | 0 |
| 1 | 0 | 0 |
| 1 | 1 | 1 |

对于 $n$ 个输入的逻辑函数，会有 $2 ^ n$ 个可能的输入取值，和与之对应的输出，真值表会有 $n + 1$ 列， $2 ^ n$ 行。

有时候有些输入情况是不存在或不需要考虑的，此时我们可以省略这些情况对应的行，或者将对应输出用 X 表示。

#### 1.2.5 基本逻辑运算

在逻辑函数中，最基本的逻辑运算有与、或、非三种运算。

**与运算**

与运算用符号“ $\cdot$ ”表示，称为与。

两个变量的与运算的逻辑表达式为：

$$F = A \cdot B$$

$n$ 个变量的与运算的逻辑表达式为：

$$F = A_1 \cdot A_2 \cdot \cdots \cdot A_n$$

也可以使用真值表来表示：

| 输入 A | 输入 B | 输出 F |
| ---  | --- | --- |
| 0 | 0 | 0 |
| 0 | 1 | 0 |
| 1 | 0 | 0 |
| 1 | 1 | 1 |

与运算在所有输入都为 1 时，逻辑函数 F 才为 1，有任一输入为 0 时 F 为 0。

**或运算**

或运算用符号“ $+$ ”表示，称为或。

两个变量的或运算的逻辑表达式为：

$$F = A + B$$

$n$ 个变量的或运算的逻辑表达式为：

$$F = A_1 + A_2 + \cdots + A_n$$

也可以使用真值表来表示：

| 输入 A | 输入 B | 输出 F |
| ---  | --- | --- |
| 0 | 0 | 0 |
| 0 | 1 | 1 |
| 1 | 0 | 1 |
| 1 | 1 | 1 |

或运算在有任一输入为 1 时，逻辑函数 F 就为 1，全部输入都为 1 时 F 为 0。

**非运算**

非运算用符号“ $'$ ”表示，称为非。

非运算的逻辑表达式为：

$$F = A'$$

非运算只能有一个逻辑变量输入。

也可以使用真值表来表示：

| 输入 A | 输出 F |
| ---  | --- |
| 0 | 1 |
| 1 | 0 |

非运算也叫反相运算，或者取反运算。在输入为 0 时，输出 1；在输入为 1 时，输出 0。

#### 1.2.6 逻辑表达式

以上介绍了三种基本逻辑运算，以及对应的运算符号“ $\cdot$ ”，“ $+$ ”，“ $'$ ”，它们统称为逻辑运算符。由逻辑变量和逻辑运算符组成的表达式被称为逻辑函数表达式或逻辑表达式，简称为逻辑式。它是描述逻辑函数与逻辑变量之间关系的表达式，逻辑式和真值表都是描述逻辑函数的重要工具。

有一些较为复杂的逻辑式也是由基本运算符组合而成的。三种运算符混合运算式中，运算次序是 **非——与——或**，若有括号，则先进行括号内运算。

设有两个逻辑函数：

$$F_1(A_1, A_2, \cdots, A_n)$$

$$F_2(A_1, A_2, \cdots, A_n)$$

如果对于 $A_1$ ~ $A_n$ 的任何一组取值使 $F_1$ 和 $F_2$ 具有相同的值，则称这两个逻辑函数相等或等价，既 $F_1 = F_2$。相等的逻辑函数一定有相同的真值表，反之亦然。

### 1.3 电源、电线、用电器

#### 1.3.1 电路激活过程

在泰拉瑞亚中，电路由电源、电线、用电器组成，电源产生的电信号经电线传导到用电器，用电器响应该电信号。

由于电线和图格处于不同图层，它们可以重叠。如果某电线与某图格重叠，我们说该图格在该电线下，该电线在该图格上。

本教程接下来的讨论中，将会用激活来表示电路的活跃状态：**电源激活——电源上的电线激活——电线下的用电器激活** 。

#### 1.3.2 电源和用电器

电源指可以激活其上电线的图格或该图格对应的精灵（指多个图格构成的实体），每个电源有其特有的激活条件。

> 比如开关（单图格）、拉杆（多图格）等。

用电器指可被其上电线激活的图格或该图格对应的精灵，每个用电器被激活时有其特有的响应方式。

> 比如火把（单图格）、传送器（多图格）等。

> 如果需要了解电源的激活条件或用电器的响应效果，可以阅读物品介绍或查询wiki，本教程后文中也会介绍部分电源和用电器。

#### 1.3.3 多图格电源和用电器

对于由多个图格组成的电源和用电器，并不会因为电线连接一个电源或用电器的多个图格而增加电源的激活次数或用电器的被激活次数，只连接一个图格和连接多个图格是一样的，都只会激活一次。

> 比如拉杆、传送器、雕像等。

有些用电器的响应效果会根据激活图格的位置不同而改变，但是对于一次激活仍然只会响应一次。

> 比如炮台、传送枪台等；炮台发射了炮弹就不会转向，转向了就不会发射炮弹。

#### 1.3.4 有冷却时间的用电器

有些用电器的响应会受冷却时间限制，在冷却时间结束前被激活也不会响应。

> 比如炮台、飞镖机关等。

有冷却时间的用电器被激活并响应后，用电器所在的所有图格坐标会被加入到冷却机关列表（多图格用电器的每个格子都会被加入），在图格冷却结束后该坐标会从列表中移除，冷却机关列表是所有电路物品共用的。

当列表已满或用电器的所有图格都在冷却列表中时（多图格用电器需要所有图格都在列表里），用电器被激活后不会响应。计时器也使用冷却时间列表记录下一次激活的时间，但开启和关闭并不受冷却时间影响。列表满后开启的计时器不会激活。

将正在冷却的用电器挖掉并不会从列表中移除该用电器的图格，但挖掉计时器会将计时器从列表中移除，计时器不会再激活。

> 冷却机关列表类似于栈，对于冷却时间相同的项，是后进先出的，计时器电路中会使用这个性质。

没有冷却时间的用电器可以在一帧内被激活任意次数。

> 比如逻辑门灯、炮台转向、像素盒、晶莹宝石块、促动器等

#### 1.3.5 逻辑电源和物理电源

电源可以被分为逻辑电源和物理电源，逻辑电源指的是逻辑门，物理电源指的是除了逻辑门以外的电源，只有物理电源能新建逻辑结算，逻辑电源不能新建逻辑结算。

#### 1.3.6 状态表示和激活表示

有些电源和用电器是有状态的。电源一般会在状态改变时激活；用电器在激活后切换状态。我们可以叫它们为状态电源或状态用电器。

> 比如电源：普通逻辑门、开关、拉杆、加重压力板、感应器等；用电器：普通逻辑门灯、火把、灯笼、晶莹宝石块、促动器等。

例如开关和拉杆在由开切换到关、由关切换到开时都会激活，加重压力板会在抬起切换到落下、落下切换到抬起时都激活（也可以理解为加重压力板和感应器在满足条件时激活一次，不满足条件后会再激活一次）；火把和普通逻辑门灯会在激活后由亮切换到灭、或由灭切换到亮——具体是哪种取决于在激活前的状态。

![1_3_6_1_火把与开关](/images/1/3/6/1.png)

> 图中火把和开关的状态同步，所以我们可以用火把的状态来代表开关的状态，或者这条电线上连接的其他二值用电器的状态。

对于有两个状态的电源或用电器，我们可以人为设定一个状态为0（一般指灭或初始态），另一个状态为1（一般指亮或另一态）。

> 也有一些状态电源和用电器不止两个状态，比如烟囱有三个状态、炮台有九个状态、彩线灯泡有十六个状态。

我们称使用状态电源和状态用电器的电路为状态表示电路，状态表示电路的状态可以从电路中直接读出。

另一些电源和用电器是没有状态的。电源会在满足条件时激活一次，不满足条件后不会再激活一次；用电器在激活后会执行响应。我们可以叫它们为激活电源或激活用电器。

> 比如电源：普通压力板、压力垫板、故障逻辑门；用电器：故障逻辑门灯、广播盒。

![1_3_6_2_压力板与广播盒](/images/1/3/6/2.png)

对于激活电源和用电器的每个瞬间，每个电源和用电器都有激活和不激活两种状态，我们可以令激活为1，不激活为0。

> 这里的“瞬间”指的是电路结算的最小单位，对于逻辑门电路来说是“逻辑帧”，对于其他电路来说是“格子”。

我们称使用激活电源和激活用电器的电路为激活表示电路，激活与否并不会改变激活电源和激活用电器的状态，所以电路的状态不能从电路中直接读出。

实际使用时，经常会在一个电路中同时使用状态表示与激活表示，这时需要我们使用状态表示与激活表示转换电路。

#### 1.3.7 电线

现实中的数字电路电线会有低电平、高电平、高阻态等状态，但是泰拉瑞亚中的电线只能传递信号（激活），本身并没有状态（电平）。对于逻辑门电路来说，电线只是标记电源和用电器的连接关系（拓扑关系），与颜色、长度和形状无关。

电线没有长度和连接电源或用电器数量的限制，连接或不连接电线不会改变电源和用电器的状态。电路中只有电源会发送信号，只有用电器会接收信号，电线上传递的信号只有激活一种，所以除了 **电源激活——电线激活——用电器激活** 一种形式，用电器和用电器间、电源和电源间、用电器和电源间，并不会通过电线传递其他任何形式的信号或影响。

![1_3_7_1_不同颜色的电线](/images/1/3/7/1.png)

共有四种颜色的电线，相同颜色的电线在相邻图格会被连接到一起，而不同颜色的电线是在不同的图层上，不会被连接到一起。

![1_3_7_2_不同颜色的电线在不同的图层](/images/1/3/7/2.png)

使用分线盒或像素盒可以把一个图格内的相同颜色的电线分开。分线盒同时作用于一个图格中所有颜色的电线。一共有三种分线盒，分别把来自上下和左右、上左和下右、上右和下左的电线分开。使用锤子敲击可以切换分线盒的三种状态。像素盒只能将来自上下和左右的电线分开。

![1_3_7_3_分线盒与像素盒](/images/1/3/7/3.png)

#### 1.3.8 电线的脉冲信号

状态电源改变状态会发送一个信号，状态用电器在接收到信号后会改变状态；激活电源在满足条件后发送一个信号，激活用电器在接收到信号后会执行响应。如果把状态电源的“改变状态”看成激活电源的“满足条件”的一种，状态用电器的“改变状态”看成激活用电器的“执行响应”的一种，可以认为状态电源和状态用电器是一种特殊的激活电源和激活用电器。所以对于连接电源和用电器的电线来说，与激活电源和激活用电器一样，每个逻辑帧（周期）只有激活（有信号）和不激活（无信号）两种状态，和脉冲信号一致。所以可以认为电线上传递的信号是脉冲信号，电源满足条件发送脉冲信号，用电器接收脉冲信号并响应。脉冲信号在每个周期的结束都会归0，与电线的无状态一致。

#### 1.3.9 线非

非逻辑是指输入与输出相反的一种逻辑，既输入0时输出1，输入1时输出0，非逻辑也被称为取反，非逻辑门也被称为反相器。下面是非逻辑的真值表：

| 输入 A | 输出 Y |
| ---  | --- |
| 0 | 1 |
| 1 | 0 |

由于电线是没有状态的，电路中有状态的只有电源和用电器。对于一个电路的输入是电源，输出是用电器，而电源和用电器的状态又是可以人为设定的，所以我们考虑下面的电路：

![1_3_9_1_线非电路图](/images/1/3/9/1.png)

![1_3_9_2_线非真值表](/images/1/3/9/2.png)

其中，左边的火把与开关的状态相同，所以可以代替开关的状态，它表示输入；而右边的火把表示输出。观察输入和输出的关系可以发现，输出与输入正好相反，由此实现了非逻辑。

设输入为A，输出为Y，则可以用 $Y = A'$ 来表示非逻辑输入与输出的关系。

像这样实现非逻辑并没有使用逻辑门，只使用了电线，所以可以被称为“线非”。

由于线非的存在，我们可以在任何状态用电器处进行取反，而不需要非逻辑门。

#### 1.3.10 线异或

异或逻辑是一种非常常用的逻辑，对于二输入异或，在两个输入不同时输出1，在两个输入相同时输出0。下面是异或逻辑的真值表：

| 输入 A | 输入 B | 输出 Y |
| ---  | --- | --- |
| 0 | 0 | 0 |
| 0 | 1 | 1 |
| 1 | 0 | 1 |
| 1 | 1 | 0 |

异或门又叫做可控非门或可控反相器，注意异或逻辑的真值表，当输入B为0时，输出Y等于输入A的值；当输入B为1时，输出Y等于输入A取反后的值，所以可以认为输入B控制是否对A取反。

具体到泰拉电路中，当电线不被激活时，电线下用电器的状态不会改变；当被激活时，会将电线下用电器切换为另一个状态，也就是取反。这正好与异或逻辑相同。

考虑以下电路：

![1_3_10_1_线异或电路图](/images/1/3/10/1.png)

由于左侧火把只与开关连接，故火把可以代替开关状态，设左侧火把为输入，右侧火把为输出。

设A先输入，B后输入，由于初始状态为0，故A输入后输出Y等于A；当B输入0时，输出不变，当B输入1时，输出被取反，与异或逻辑相同。由于异或具有交换律，交换A和B的输入顺序结果不会改变，所以结果与A和B的先后顺序无关，具有普适性。

![1_3_10_2_线异或真值表](/images/1/3/10/2.png)

我们可以用 $Y = A \mathbin{\hat{}} B$ 来表示A异或B的结果是Y。

同理，由于两两异或具有结合律，$Y = A \mathbin{\hat{}} B \mathbin{\hat{}} C = (A \mathbin{\hat{}} B) \mathbin{\hat{}} C = A \mathbin{\hat{}} (B \mathbin{\hat{}} C)$ ，运算顺序并不会改变结果，所以我们可以增加任意数量的输入，下图中的输出为输入间**两两异或**的结果。

![1_3_10_3_线两两异或电路图](/images/1/3/10/3.png)

$Y = A \mathbin{\hat{}} B \mathbin{\hat{}} C \mathbin{\hat{}} D \mathbin{\hat{}} E \mathbin{\hat{}} F$

> 请注意两两异或和异或门在只有两个输入时相同，在超过两个输入时不同，输入间两两异或的逻辑门也被称为奇校验门，而对结果取反为偶校验门

像这样实现异或逻辑并没有使用逻辑门，只使用了电线，所以可以被称为“线异或”。

由于线异或的存在，我们可以在任何状态用电器处实现异或逻辑而不需要异或逻辑门。

因为线异或是在状态用电器处完成，所以不同颜色的电线连接到同一个状态用电器，仍然满足异或逻辑关系。

![1_3_10_4_不同颜色线异或](/images/1/3/10/4.png)

#### 1.3.11 线或

如果我们将上一节的状态用电器火把换成激活用电器广播盒，并认为广播盒激活为1，不激活为0，那么我们会发现这个电路在输入不全为0时都会输出1，不再满足异或逻辑，而是满足或逻辑。下面是或逻辑的真值表：

| 输入 A | 输入 B | 输出 Y |
| ---  | --- | --- |
| 0 | 0 | 0 |
| 0 | 1 | 1 |
| 1 | 0 | 1 |
| 1 | 1 | 1 |

既在输入不为0时，输出为1。

![1_3_11_1_线或电路图](/images/1/3/11/1.png)

我们可以用 $Y = A + B$ 来表示A或B的结果是Y。

需要注意的是，线非、线异或、线或实际是在用电器处完成，线非和线异或只对状态状态用电器成立，而线或只对激活用电器成立，线非和线异或使用的频率较高。

#### 1.3.12 电线的参考状态

前文中，我们将状态电源开关与状态用电器火把直接相连，因为它们状态是同步变化的，所以用火把的状态来代替开关的状态。同理，尽管电线本身是没有状态的，但是有时为了便于讨论，我们会设定电线是有状态的，这种状态称为参考状态，与实际状态无关，是人为设定的。

当我们使用电线连接状态电源和状态用电器时，电线会将状态电源的状态传递给状态用电器，我们将这种电线称为状态传递电线，简称状态电线。通常设定状态电线在没被激活或激活次数为偶数次时状态为0，电线被激活次数为奇数次时状态为1。类似于在状态电线上放置一个熄灭的火把，在火把熄灭时表示电线的状态是0，在火把点亮时表示电线的状态是1。

![1_3_12_1_状态电线](/images/1/3/12/1.png)

当我们使用电线连接激活电源和激活用电器时，电线和激活电源与激活用电器一样，每个逻辑帧只有激活与不激活两种状态，我们将这种电线称为激活传递电线，简称激活电线。类似的，设定在任一逻辑帧，激活电线不激活为0，激活电线激活为1。

![1_3_12_2_激活电线-1](/images/1/3/12/2.png)

当我们使用电线连接激活电源和状态用电器，或状态电源和激活用电器时，根据我们更加关注的是这根电线连接的状态用电器的状态，还是用电器是否被激活，来决定是激活电线还是状态电线。

![1_3_12_3_状态电线-2](/images/1/3/12/3.png)

> 使用激活电源压力板连接状态用电器火把，我们关心的是火把的状态，而不是压力板是否被激活，所以图中电线是状态电线。

![1_3_12_4_激活电线-2](/images/1/3/12/4.png)

> 使用状态电源开关连接激活用电器广播盒，我们关心的是广播盒是否被激活，而不是开关的状态，所以图中电线是激活电线。

### 1.4 逻辑门灯、逻辑门

#### 1.4.1 逻辑门灯

逻辑门灯是用电器，简称为逻辑灯。逻辑门灯有两种，分别是逻辑门灯亮/灭，通称为普通逻辑灯或普通灯；和逻辑门灯（故障），简称为故障逻辑灯或故障灯。

![1_4_1_1_三种逻辑门灯](/images/1/4/1/1.png)

> 三种逻辑门灯，分别是逻辑门灯灭、逻辑门灯亮、逻辑门灯（故障）

普通逻辑门灯是状态用电器，有灭和亮两种状态；而故障逻辑灯是激活用电器，在每一个逻辑帧有激活和不激活两种状态，激活与不激活不会改变故障逻辑灯的显示效果。

逻辑灯必须堆叠在逻辑门上，我们说这些逻辑灯在该逻辑门上，该逻辑门在这些逻辑灯下。

![1_4_1_2_逻辑门灯在逻辑门上](/images/1/4/1/2.png)

> 逻辑门灯在逻辑门上的样子

#### 1.4.2 逻辑门

逻辑门是电源，逻辑门是否激活（改变状态）受其上逻辑灯影响，不同的逻辑门有不同的逻辑判定规则。

在逻辑门上面没有故障逻辑门灯，只有普通逻辑灯时，我们叫它们普通逻辑门。一共有与、与非、或、或非、异或、同或六种普通逻辑门。普通逻辑门是状态电源，有亮和灭两种状态。

![1_4_2_1_普通逻辑门](/images/1/4/2/1.png)

而当逻辑门上有故障逻辑灯时，它会变成蓝色，成为故障逻辑门，所有故障逻辑门的逻辑都是一样的（尽管它们贴图不同）。故障逻辑门是激活电源，在每一个逻辑帧都有激活和不激活两种状态，激活与不激活不会改变故障逻辑门的显示效果。

![1_4_2_2_故障逻辑门](/images/1/4/2/2.png)

当一个逻辑门上的逻辑灯激活后，逻辑门会进行逻辑判定并改变状态，当逻辑门状态改变时会激活；状态不变时不会激活。

#### 1.4.3 普通逻辑门

六种普通逻辑门在其上逻辑灯激活时，会根据其上所有逻辑灯的状态决定自身状态，在新状态与原状态相同时不会激活，在新状态与原状态不同时会激活。下面是三输入普通逻辑灯状态（输入）与逻辑门状态（输出）间的关系：

| 输入 A | 输入 B | 输入 C | 与输出 AND | 与非输出 NAND | 或输出 OR | 或非输出 NOR | 异或输出 XOR | 同或输出 XNOR |
| ---  | --- | --- | --- | --- | --- | --- | --- | --- |
| 0 | 0 | 0 | 0 | 1 | 0 | 1 | 0 | 1 |
| 0 | 0 | 1 | 0 | 1 | 1 | 0 | 1 | 0 |
| 0 | 1 | 0 | 0 | 1 | 1 | 0 | 1 | 0 |
| 0 | 1 | 1 | 0 | 1 | 1 | 0 | 0 | 1 |
| 1 | 0 | 0 | 0 | 1 | 1 | 0 | 1 | 0 |
| 1 | 0 | 1 | 0 | 1 | 1 | 0 | 0 | 1 |
| 1 | 1 | 0 | 0 | 1 | 1 | 0 | 0 | 1 |
| 1 | 1 | 1 | 1 | 0 | 1 | 0 | 0 | 1 |

![1_4_3_1_三输入普通逻辑门](/images/1/4/3/1.png)

* 与门会在所有输入都为1时为1，其余输入为0；与非门是将与门结果取反；
* 或门会在所有输入都为0时为0，其余输入为1；或非门是将或门结果取反；
* 异或门会在输入中只有一个1时为1，其余输入为0；同或门是将异或门结果取反。

> 有时同或门也叫异或非门，请注意异或门/同或门与奇校验门/偶校验门的区别

下表中为六种逻辑门的逻辑表达式，与使用 $\cdot$ 表示，或使用 $+$ 表示，非使用 $'$ 表示。

| 逻辑门 | 逻辑表达式 |
| ---  | --- |
| 与门 | $Y = A \cdot B \cdot C$ |
| 与非门 | $Y = (A \cdot B \cdot C)'$ |
| 或门 | $Y = A + B + C$ |
| 或非门 | $Y = (A + B + C)'$ |
| 异或门 | $Y = A \cdot B' \cdot C' + A' \cdot B \cdot C' + A' \cdot B' \cdot C$ |
| 同或门 | $Y = (A \cdot B' \cdot C' + A' \cdot B \cdot C' + A' \cdot B' \cdot C)'$ |

#### 1.4.4 普通逻辑门的等价

泰拉里有六种普通逻辑门，看起来非常复杂，但是实际上其中的大部分逻辑门都是等价的。

由于线非的存在，我们可以在任意状态用电器取反，所以完全可以在输出（火把）取反，用与、或、异或门来代替与非、或非、同或门，这样我们就将六种逻辑门减少到了三种逻辑门。

![1_4_4_1_普通逻辑门的等价-1](/images/1/4/4/1.png)

首先我们需要知道布尔代数中有两个重要的定律，被称为反演定律（或摩根定律）：

$(A \cdot B)' = A' + B'$

$(A + B)' = A' \cdot B'$

> 关于这两个定律的证明可以通过画图或者列真值表完成，对于三项及三项以上仍然是成立的。

由此我们可以进行推导：

将或门的逻辑表达式进行两次取反（两次取反结果不变），然后使用反演律将或逻辑转换为与逻辑：

$Y = A + B + C = (A + B + C)'' = (A' \cdot B' \cdot C')'$

上式表明将与逻辑的输入与输出都取反，得到的就是或逻辑。使用线非我们也能对输入（逻辑灯）取反，所以我们可以用与门来代替或门，这样我们就将剩下的三种逻辑门减少到了与门和异或门两种逻辑门。

![1_4_4_2_普通逻辑门的等价-2](/images/1/4/4/2.png)

那么我们是否能将与门和异或门等价呢？不可能，原因会在后文介绍。在泰拉电路中，我们只使用与门和异或门就足够了，其他普通逻辑门都可以用这两种门代替。

#### 1.4.5 最简单的普通逻辑门

最简单的普通逻辑门是只有一个普通逻辑灯的普通逻辑门：

![1_4_5_1_最简单的普通逻辑门](/images/1/4/5/1.png)

它的输入与输出始终相等，称为缓冲门（也被称为同相器）。对于只有一个逻辑门灯的与门和异或门，它们等价，所以可以使用六种普通逻辑门来实现这种逻辑门。

尽管这种逻辑门看起来没什么用，但是泰拉瑞亚电路对时序要求极高，所以会使用这种逻辑门来进行逻辑延时；同时它也能单向传递信号；有时候也需要用它来更换电线颜色。在泰拉瑞亚中它又被叫做逻辑延时器（取逻辑延时功能）、二极管（取单向传递信号功能）、换线器（取更换电线颜色功能）。

> 由于线非的存在，实际上也可以作为非门使用，只是一般不这么考虑。

#### 1.4.6 故障逻辑门

如果任意的普通逻辑门上有至少一个故障逻辑灯，那么该逻辑门会变为蓝色，称为故障逻辑门。故障逻辑门是一个（不是一类）特殊的逻辑门，无论其下方的普通逻辑门是什么，故障逻辑门的性质是相同的。

故障逻辑门与其上最下方的故障逻辑灯之间的普通逻辑灯为有效逻辑灯。当故障逻辑门上有任意一个故障逻辑灯被激活时，故障逻辑门会依一定概率激活，该概率等于有效逻辑灯中亮灯的数量除以所有有效逻辑灯的数量。

![1_4_6_1_不同概率的故障逻辑门"](/images/1/4/6/1.png)

> 当激活图中五个故障门的故障灯时，故障门激活的概率分别是：
>
> A: $1 \over 7$; B: $2 \over 7$; C: $6 \over 7$; D: $1 \over 2$; E: $1$;

<div style="display: flex; align-items: center; margin-bottom: 0;">
  <img src="/images/1/4/6/5.png" style="display: block; margin: 0;" />
  <div style="margin-left: 10px;">
    其他故障灯（激活效果与最下方故障灯相同）
  </div>
</div>
<div style="display: flex; align-items: center; margin-bottom: 0;">
  <img src="/images/1/4/6/3.png" style="display: block; margin: 0;" />
  <div style="margin-left: 10px;">
    其他普通灯（不影响概率）
  </div>
</div>
<div style="display: flex; align-items: center; margin-bottom: 0;">
  <img src="/images/1/4/6/4.png" style="display: block; margin: 0;" />
  <div style="margin-left: 10px;">
    
  </div>
</div>
<div style="display: flex; align-items: center; margin-bottom: 0;">
  <img src="/images/1/4/6/3.png" style="display: block; margin: 0;" />
  <div style="margin-left: 10px;">
    
  </div>
</div>
<div style="display: flex; align-items: center; margin-bottom: 0;">
  <img src="/images/1/4/6/3.png" style="display: block; margin: 0;" />
  <div style="margin-left: 10px;">
    
  </div>
</div>
<div style="display: flex; align-items: center; margin-bottom: 0;">
  <img src="/images/1/4/6/5.png" style="display: block; margin: 0;" />
  <div style="margin-left: 10px;">
    最下方故障灯（下方为有效逻辑灯）
  </div>
</div>
<div style="display: flex; align-items: center; margin-bottom: 0;">
  <img src="/images/1/4/6/4.png" style="display: block; margin: 0;" />
  <div style="margin-left: 10px;">
    有效逻辑灯（激活概率为有效亮灯比全部有效灯）
  </div>
</div>
<div style="display: flex; align-items: center; margin-bottom: 0;">
  <img src="/images/1/4/6/3.png" style="display: block; margin: 0;" />
  <div style="margin-left: 10px;">
    
  </div>
</div>
<div style="display: flex; align-items: center; margin-bottom: 0;">
  <img src="/images/1/4/6/2.png" style="display: block; margin: 0;" />
  <div style="margin-left: 10px;">
    故障逻辑门
  </div>
</div>
</br>

故障门上的故障灯为激活用电器，而普通灯为状态用电器，改变普通灯的状态不会使故障门激活，而激活故障灯有可能会使故障门激活；故障逻辑门是激活电源。

一个故障逻辑门上的所有故障逻辑灯都是相同的，而除了有效逻辑灯以外的普通逻辑灯的状态不会影响故障逻辑门的概率。

#### 1.4.7 最简单的故障逻辑门

最简单且最常用的故障逻辑门是只有一个有效逻辑灯的故障逻辑门。

![1_4_7_1_单有效灯故障门"](/images/1/4/7/1.png)

* 当有效灯熄灭时，激活概率为0，故障灯激活时，故障门永远不会激活；
* 当有效灯点亮时，激活概率为1，故障灯激活时，故障门永远会激活。

#### 1.4.8 组合逻辑与时序逻辑

在不发生爆门的情况下，因为普通灯和普通门分别是状态用电器和状态电源，所以每根电线都是状态电线，每根线只在某个固定的逻辑帧激活。输入和输出都是状态表示的，每个输出对应一个逻辑函数，可以用真值表列出。这种所有电线都是状态电线的电路被称为组合逻辑电路。

可以利用爆门制作脉冲，将普通灯转换为类似激活用电器，转换成激活用电器的普通灯对应的逻辑门也会变成激活电源；故障灯和故障门分别是激活用电器和激活电源，连接激活电源和激活用电器的是激活电线。激活电线用激活与否来传递信息，同一根电线可能在不同的逻辑帧激活，并且不同的逻辑帧激活可能表示不同的信号。这种有至少一根电线是激活电线的电路被称为时序逻辑电路。

### 1.5 逻辑结算

#### 1.5.1 结算层次

泰拉瑞亚中每一帧中，除电路外所有的游戏机制会依一定顺序结算，电路结算的位置和触发电路的物理电源结算位置有关。也就是说，当实体触发电路时，会在实体所在结算位置插入电路结算。比如由玩家、NPC、射弹触发的电路会分别在玩家、NPC、射弹处结算。

泰拉瑞亚的电路结算由五层构成：**逻辑结算（物理电源）——逻辑帧结算——电源结算——电线结算——格子结算** ，每一层结算由下一层结算组成。

#### 1.5.2 逻辑结算

当物理电源激活时，会新建一个逻辑结算，而逻辑电源无法新建逻辑结算。物理电源激活和逻辑结算是一一对应的。一帧内有多少物理电源激活，就会新建多少逻辑结算，逻辑结算的数量是没有限制的。而在逻辑结算结算完成前，后续的代码不会运行，所以无论逻辑结算的规模有多大，有多少逻辑门和多少电线，都会在一帧内完成。综上，可以说泰拉瑞亚电路是没有频率上限；且没有延迟的（实际上频率会受限于能制作出来的驱动/时钟频率；延迟会受限于电脑性能，当计算量较大时，物理帧会降低）。

#### 1.5.3 逻辑帧结算

对于涉及逻辑门的电路，逻辑结算被分步进行，每一步中都进行 **逻辑门激活——电线激活——逻辑灯激活——逻辑门判断** 这四小步。我们将这样的四步统称为逻辑帧。一个逻辑电路的结算过程中，反复运行每个逻辑帧中的四小步，直到没有逻辑门需要激活。

在逻辑灯状态改变后，并不会马上进行逻辑门是否激活的判断。而是等所有逻辑门（来自上一逻辑帧激活的逻辑门）、逻辑门上的所有电线、电线的每一个格子都结算完再进行判断。

所以我们应该以逻辑帧为单位分析逻辑电路，对于逻辑电路来说，逻辑帧内的事情是同时发生的。每一个逻辑帧只需要考虑逻辑灯的终态，不需要考虑中间态，就能判断这一逻辑帧后某一个逻辑门是否激活。（普通灯考虑亮灭，故障灯考虑在该逻辑帧是否激活）

![1_5_3_1_逻辑门结算-1](/images/1/5/3/1.png)

> 考虑上图中的电路，红线激活后，会将故障灯设为激活态；普通灯由亮切换为灭。所有电源（只有开关）和所有电线（只有红线）结算完后，故障门根据其上逻辑灯状态——故障灯激活、普通灯灭，判断为不激活。

![1_5_3_2_逻辑门结算-2](/images/1/5/3/2.png)

> 考虑上图中的电路，红线激活后，会将故障灯设为激活态；普通灯由灭切换为亮。所有电源（只有开关）和所有电线（只有红线）结算完后，故障门根据其上逻辑灯状态——故障灯激活、普通灯亮，判断为激活，激活后点亮火把。

由上述可得，两个相邻逻辑帧间相隔一个逻辑门。故可以通过数出一个信号从物理电源传递到某个逻辑门时经过的逻辑门数量，来计算该逻辑门所在逻辑帧位置。

![1_5_3_3_逻辑帧](/images/1/5/3/3.png)

我们一般令物理电源所在逻辑帧为第 0 逻辑帧，每经过一个逻辑门逻辑帧 +1 ，所以我们可以通过数逻辑门得到逻辑帧数。

> 当需要分析两个逻辑门间差多少逻辑帧时，我们可以上溯到它们的公共逻辑帧。

以下的电源结算、电线结算、格子结算顺序在逻辑门电路中被认为是同时发生的，所以不需要考虑它们的顺序对逻辑门电路的影响。

#### 1.5.4 电源结算

每个逻辑帧中，会按照上一逻辑帧访问（被添加到电源队列）的先后顺序，结算上一逻辑帧激活的所有电源。

#### 1.5.5 电线结算

每个电源上连接的四种颜色的电线，会按照 **红——蓝——绿——黄** 的颜色顺序依次进行结算。

#### 1.5.6 格子结算

每个电线进行结算时，会从激活点开始，使用四连通广度优先搜索（BFS）来遍历该电线上连接的所有图格，添加到队列的顺序是 **下——上——右——左** 。一般情况下，我们只需要知道，电线上各个格子按照距离（指沿电线上的距离）电源由近到远的顺序激活。

#### 1.5.7 爆门

泰拉瑞亚电路没有延迟，逻辑结算不完成程序不会继续，那么以下的电路激活会发生什么？

![1_5_7_1_爆门](/images/1/5/7/1.png)

> 开关激活电线，电线激活逻辑灯，逻辑灯改变状态，与门改变状态，与门激活电线，电线激活逻辑灯，逻辑灯改变状态，与门改变状态，与门激活电线，电线激活逻辑灯，逻辑灯改变状态，与门改变状态……

如此简单的电路就能让程序陷入死循环，卡死泰拉瑞亚？

然而实际尝试后我们会发现逻辑门冒烟了，但是游戏并没有被卡死，这是怎么回事呢？

![1_5_7_2_冒烟](/images/1/5/7/2.png)

泰拉瑞亚开发者为了防止无延迟的电路出现死循环卡死游戏的情况，为逻辑门添加了一个设定，既同一个逻辑门在一次逻辑结算中只能激活一次。如果尝试激活第二次，那么逻辑门的状态虽然会正常切换，但会激活失败，不会激活电线，并有白烟从逻辑门冒出，这种现象称为 **爆门** 。

实际上，使用爆门来防止死循环，也会产生一些副作用，有些不会死循环的电路也会发生爆门。在实际应用中，爆门经常导致电路bug，这是因为我们往往希望逻辑门在多次状态切换时可以多次激活，但实际上不会。学会了预测爆门，就可以想办法避免爆门，甚至利用爆门。

#### 1.5.8 竞争和冒险

泰拉瑞亚中的爆门，往往是同一个逻辑门的不同输入到达逻辑门的时间（逻辑帧）不同导致的，先到的信号改变了逻辑门的状态，而后到的信号如果也想改变逻辑门状态，因为逻辑门已经被激活过，所以此时逻辑门状态会改变但不会发出信号，发生爆门。

现实电路中也有类似的概念，既竞争和冒险：

- 竞争：输入信号通过两条或者两条以上路径输出到同一个门电路，由于两条路径上的延迟不同，出现了到达先后时间差的情况；

- 冒险：由于竞争的存在，有可能会出现尖峰脉冲，导致瞬间逻辑错误的情况；

我们可以使用和现实类似的两个方法来避免爆门：

- 给先到达的信号添加延时，以让它和后到达的信号同时（同逻辑帧）到达一个逻辑门；（组合逻辑）

- 使用寄存器暂存信号，在需要时将它们同时（同逻辑帧）发送给逻辑门；（时序逻辑）

现实中还有一些其他方法，不过对于泰拉来说比较麻烦（如增加冗余项）或无法实现（如添加滤波电容）。

### 1.6 MechScope 模组

#### 1.6.1 介绍

泰拉瑞亚的电路是没有延迟的，所以我们没办法看到一个电路运行的中间过程，我们对于一个电路像黑箱一样只知道输入和输出。尤其是泰拉电路对时序要求很高，经常会有时序不同步出现爆门或错误。对于几千乃至上万个逻辑门组成的电路，有几百乃至几千个逻辑帧，非常难以测试。

此时我们可以使用 MechScope 模组来测试电路，这个模组并不会改变电路的逻辑，它可以暂停与步进电路，让我们可以看到电路运行时每一个结算步骤。

在 tModLoader 的创意工坊订阅并启用 MechScope 后，应该看起来像下面这样：

![1_6_1_1_MechScope](/images/1/6/1/1.png)

在开始前，我们需要去 设置——控件——快捷键绑定 中设置 MechScope 的模组按键：

![1_6_1_2_模组按键](/images/1/6/1/2.png)

这几个按键的功能如下：

| 英文 | 中文 | 功能 |
| ---  | --- | --- |
| Toggle | 触发 | 启用/禁用电路步进，启用后鼠标指针右上角会多出一个黄色正方形，启用时暂停电路，当有未结算完成的电路时，会变为红色 |
| Step | 步进 | 按下后电路步进一步，可以在设置中选择步长为格子、电线、电源、逻辑帧四种 |
| Auto step | 自动步进 | 启用/禁用自动步进，启用后鼠标指针右上角会多出一个绿色正方形，之后会按照设置的自动步进时间自动对电路步进 |
| Settings | 设置 | 打开/关闭设置界面，可以设定一些参数 |

打开设置界面后，我们可以看到这样的界面：

![1_6_1_3_模组设置](/images/1/6/1/3.png)

我们重点关注以下几个参数：

Set mode 步进步长

| 英文 | 中文 | 功能 |
| ---  | --- | --- |
| Single | 格子 | 逐格步进，电路结算最小单位 |
| Wire | 电线 | 逐线步进 |
| Source | 电源 | 逐源步进 |
| Stage | 逻辑帧 | 逐逻辑帧步进，对于逻辑门电路，一般使用这个选项 |

Auto-step rate 自动步进重复速率（单位：帧，越小速度越快）

Queued wire trips 物理电源缓冲队列长度（最大为100，超过100后激活的物理电源将被抛弃）

其他六项为显示设置，仅影响可视化程度，这里不进行介绍，读者可自行尝试。

#### 1.6.2 逐格步进

设置菜单中选择逐格步进，然后做出图中所示的电路：

![1_6_2_1_逐格步进电路](/images/1/6/2/1.png)

启用MechScope，鼠标指针右上角会多出一个黄色正方形，当有未结算完成的电路时，会变为红色：

![1_6_2_2_电路暂停_结算完成](/images/1/6/2/2.png)

![1_6_2_3_电路暂停_结算未完成](/images/1/6/2/3.png)

右键点击开关，可以看到开关上出现了红框，表示开关作为电源，激活了它上面的红线：

![1_6_2_4_逐格步进-1](/images/1/6/2/4.png)

按下步进键，开关右边一格出现了红框，表示这一格激活：

![1_6_2_5_逐格步进-2](/images/1/6/2/5.png)

反复步进，红框一直向右移动直到火把上，把火把关闭：

![1_6_2_6_逐格步进-3](/images/1/6/2/6.png)

![1_6_2_7_逐格步进-4](/images/1/6/2/7.png)

![1_6_2_8_逐格步进-5](/images/1/6/2/8.png)

![1_6_2_9_逐格步进-6](/images/1/6/2/9.png)

![1_6_2_10_逐格步进-7](/images/1/6/2/10.png)

> 对于较为复杂的格子结算顺序，读者可以自己使用 Mech Scope 模组研究。

![1_6_2_11_BFS](/images/1/6/2/11.png)

#### 1.6.3 逐线步进

设置菜单中选择逐线步进，然后做出图中所示的电路：

![1_6_3_1_逐线步进电路](/images/1/6/3/1.png)

在逐线步进模式下，每次步进会前进一整根电线。右键点击开关，可以看到红线激活：

![1_6_3_2_逐线步进-1](/images/1/6/3/2.png)

步进，蓝线激活：

![1_6_3_3_逐线步进-2](/images/1/6/3/3.png)

步进，绿线激活：

![1_6_3_4_逐线步进-3](/images/1/6/3/4.png)

步进，黄线激活：

![1_6_3_5_逐线步进-4](/images/1/6/3/5.png)

这个实验展示了单个电源上不同电线的激活顺序： **红线——蓝线——绿线——黄线** 依次激活。

#### 1.6.4 逐源步进

做出图中所示的电路：

![1_6_4_1_逐源步进电路](/images/1/6/4/1.png)

首先先在设置菜单中选择逐格步进，让我们先看一下在“上一逻辑帧”中这几个电源的访问/激活顺序：

![1_6_4_2_逐格步进-1](/images/1/6/4/2.png)

![1_6_4_3_逐格步进-2](/images/1/6/4/3.png)

![1_6_4_4_逐格步进-3](/images/1/6/4/4.png)

![1_6_4_5_逐格步进-4](/images/1/6/4/5.png)

![1_6_4_6_逐格步进-5](/images/1/6/4/6.png)

可以发现在“上一逻辑帧”中，这几个逻辑灯是从右到左被访问的，由于逻辑门和逻辑灯是一一对应的，所以逻辑门被加入到电源队列的顺序也是从右到左。

此时在设置菜单中选择逐源步进，让我们看一下在“当前逻辑帧”中电源的结算顺序：

![1_6_4_7_逐源步进-1](/images/1/6/4/7.png)

![1_6_4_8_逐源步进-2](/images/1/6/4/8.png)

![1_6_4_9_逐源步进-3](/images/1/6/4/9.png)

![1_6_4_10_逐源步进-4](/images/1/6/4/10.png)

![1_6_4_11_逐源步进-5](/images/1/6/4/11.png)

> 计划激活的逻辑门会用红色圆圈标记，已经激活过的逻辑门用白色叉标记

可以发现“当前逻辑帧”中电源的结算顺序与“上一逻辑帧”中电源被添加到电源队列的顺序是相同的。

#### 1.6.5 逐逻辑帧步进

对于逻辑门电路，不需要考虑格子、电线、电源结算顺序，同逻辑帧内发生的事情被认为是同时发生的。所以逐逻辑帧步进是我们分析逻辑门电路时最常用的模式。

设置菜单中选择逐逻辑帧步进，然后做出图中所示的电路：

![1_6_5_1_逐逻辑帧步进电路](/images/1/6/5/1.png)

右键点击开关，进入第0个逻辑帧。开关作为电源激活，开关上的红线激活，两个逻辑灯激活，两个逻辑门进行判断，并计划激活：

![1_6_5_2_逐逻辑帧步进-1](/images/1/6/5/2.png)

第1个逻辑帧。两个逻辑门作为电源激活，蓝线和绿线激活，三个逻辑灯及火把激活。其中火把改变状态，左右两个逻辑灯改变状态，中间的逻辑灯因为激活了两次（两个1异或为0），状态不变。三个逻辑灯下的逻辑门进行判断，其中左右两个逻辑门计划激活，中间的逻辑门不计划激活（因为状态不变）：

![1_6_5_3_逐逻辑帧步进-2](/images/1/6/5/3.png)

第2个逻辑帧。两个逻辑门作为电源激活，两根红线激活，四个逻辑灯及火把激活，全部改变状态。四个逻辑门计划激活：

![1_6_5_4_逐逻辑帧步进-3](/images/1/6/5/4.png)

第3个逻辑帧。四个逻辑门作为电源激活，蓝线激活四次，火把激活四次，状态不变。没有计划激活的逻辑门，逻辑结算结束：

![1_6_5_5_逐逻辑帧步进-4](/images/1/6/5/5.png)

![1_6_5_5_逐逻辑帧步进-5](/images/1/6/5/6.png)

> 在逻辑结算步进中禁用电路步进时，会将当前逻辑结算进行完，物理电源队列里待结算的物理电源会被抛弃。
